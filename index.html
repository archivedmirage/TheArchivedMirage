<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Archived Mirage</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@300;400;600&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

<style>
/* THEME VARIABLES */
:root {
    --bg: #e3ddd3; 
    --card: rgba(255, 255, 255, 0.6);
    --text: #1a1a1a;
    --border: rgba(0, 0, 0, 0.08);
    --primary: #000000;
    --accent: #8e8a82;
    --radius: 15px; 
    --shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
    --glass-blur: 20px;
}

body.dark {
    --bg: #0d0d0c;
    --card: rgba(26, 26, 24, 0.7);
    --text: #f0f0f0;
    --border: rgba(255, 255, 255, 0.1);
    --primary: #ffffff;
    --accent: #aaaaaa;
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; transition: background 0.4s ease, color 0.4s ease, border 0.4s ease; }

body { 
    margin: 0; 
    font-family: 'Inter', sans-serif; 
    color: var(--text); 
    overflow-x: hidden; 
    line-height: 1.6;
    min-height: 100vh;
    background: var(--bg);
    background-image: 
        radial-gradient(at 0% 0%, rgba(215, 204, 185, 0.3) 0, transparent 50%), 
        radial-gradient(at 50% 0%, rgba(237, 232, 222, 0.3) 0, transparent 50%), 
        radial-gradient(at 100% 0%, rgba(215, 204, 185, 0.3) 0, transparent 50%);
    background-size: 200% 200%;
    animation: liquidMovement 10s infinite alternate ease-in-out;
}

@keyframes liquidMovement {
    0% { background-position: 0% 0%; }
    100% { background-position: 100% 100%; }
}

.brand-font { font-family: 'UnifrakturMaguntia', cursive; }

/* REFINED TEXT BOXES & FORMS */
.admin-box {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 25px;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

input, textarea {
    width: 100%;
    padding: 14px 18px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 1px;
    outline: none;
    transition: all 0.3s ease;
}

input:focus, textarea:focus {
    border-color: var(--primary);
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 4px rgba(128, 128, 128, 0.05);
}

input::placeholder, textarea::placeholder {
    color: var(--accent);
    opacity: 0.5;
    font-size: 0.65rem;
    text-transform: uppercase;
}

/* LUXURY INTRO */
#intro {
    position: fixed; inset: 0; background: #000; z-index: 10000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; animation: fadeOut 0.8s ease 3.8s forwards;
    padding: 20px; text-align: center;
}

#intro h1 {
    font-size: 2.5rem; letter-spacing: 8px; margin: 0;
    animation: textAppear 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    opacity: 0; transform: translateY(20px);
}

#intro .line { 
    width: 0px; height: 1px; background: rgba(255,255,255,0.3); 
    margin: 25px 0; 
    animation: lineGrow 1.2s ease 1.2s forwards; 
}

#intro p {
    font-size: 0.6rem; letter-spacing: 4px; opacity: 0; text-transform: uppercase;
    animation: fadeIn 1s ease 2s forwards;
}

@keyframes textAppear { to { opacity: 1; transform: translateY(0); } }
@keyframes lineGrow { to { width: 200px; } }
@keyframes fadeIn { to { opacity: 0.6; } }
@keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

/* HEADER */
header { 
    background: var(--card); 
    border-bottom: 1px solid var(--border); 
    padding: 15px 20px; 
    display: flex; 
    flex-direction: column;
    gap: 15px;
    align-items: center; 
    position: sticky; 
    top: 0; 
    z-index: 500;
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
}

@media (min-width: 768px) {
    header { flex-direction: row; padding: 20px 40px; justify-content: space-between; }
    header > div, header > nav { flex: 1; }
}

.nav-right { display: flex; align-items: center; gap: 20px; justify-content: center; }
nav { display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap; }

nav a { 
    cursor: pointer; font-size: 0.65rem; text-transform: uppercase; 
    letter-spacing: 1px; text-decoration: none; color: var(--text); opacity: 0.6;
}
nav a:hover { opacity: 1; }

/* THEME SWITCHER */
.theme-switch { position: relative; width: 40px; height: 20px; }
.theme-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; inset: 0; 
    background-color: var(--border);
    transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
    background-color: var(--text); transition: .4s; border-radius: 50%;
}
input:checked + .slider:before { transform: translateX(20px); }

/* SECTIONS */
main { 
    position: relative; 
    min-height: calc(100vh - 140px); 
    width: 100vw;
    display: flex;
    justify-content: center;
    padding: 20px 0;
}

section {
    position: absolute; 
    width: 92%;
    max-width: 1200px;
    height: fit-content;
    max-height: 80vh;
    padding: 30px 20px; 
    transition: 0.8s cubic-bezier(0.19, 1, 0.22, 1); 
    transform: translateY(30px); 
    opacity: 0;
    visibility: hidden; 
    overflow-y: auto; 
    z-index: 1;
    background: var(--card);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

@media (min-width: 768px) {
    section { padding: 60px 40px; width: 90%; }
}

section.active { 
    transform: translateY(0); 
    opacity: 1;
    visibility: visible; 
    z-index: 10; 
    pointer-events: all; 
}

/* STORE UI */
.filter-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
.filter-btn {
    background: transparent; border: 1px solid var(--border); color: var(--text);
    padding: 8px 15px; cursor: pointer; font-size: 0.6rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 1px; border-radius: 30px;
}
.filter-btn.active { background: var(--primary); color: var(--bg); border-color: var(--primary); }

.grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 15px; 
    max-width: 1400px; 
    margin: auto; 
    padding-bottom: 30px;
}

@media (min-width: 768px) {
    .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 40px; }
}

.product { 
    background: rgba(255,255,255,0.05); 
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
}

.product img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }

/* CART DRAWER */
#cartDrawer {
    position: fixed; top: 0; right: -100%; width: 100%; max-width: 450px; height: 100%;
    background: var(--card); z-index: 2000; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    display: flex; flex-direction: column; box-shadow: -20px 0 60px rgba(0,0,0,0.1);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
}
#cartDrawer.open { right: 0; }

/* MOBILE GRID OVERRIDES */
@media (max-width: 768px) {
    #home h1 { font-size: 3rem !important; }
    #contact > div > div { grid-template-columns: 1fr !important; gap: 40px !important; }
    #adminPanel > div { grid-template-columns: 1fr !important; }
}

footer { padding: 30px; text-align: center; font-size: 0.55rem; letter-spacing: 2px; opacity: 0.5; }

#cartOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 1500; display: none; }

/* Centering overrides for Home */
#home { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
</style>
</head>

<body class="dark">

<div id="intro">
    <h1 class="brand-font">The Archived Mirage</h1>
    <div class="line"></div>
    <p>Authenticity in every archive</p>
</div>

<header>
    <div class="brand-font" onclick="go('home')" style="cursor:pointer; font-size: 1.4rem; letter-spacing: 1px; white-space: nowrap;">The Archived Mirage</div>
    
    <nav>
        <a onclick="go('home')">Home</a>
        <a onclick="go('store')">Store</a>
        <a onclick="go('contact')">Contact</a>
        <a onclick="openCart()" style="position:relative; opacity: 0.6;">
            BAG <span id="cartCount" style="font-size: 10px; vertical-align: top; margin-left: 2px;">(0)</span>
        </a>
    </nav>
    
    <div class="nav-right">
        <label class="theme-switch">
            <input type="checkbox" id="themeToggle" onchange="toggleTheme()" checked>
            <span class="slider"></span>
        </label>
    </div>
</header>

<main>
    <section id="home" class="active">
        <p style="letter-spacing:5px; font-size: 0.6rem; opacity: 0.5; margin-bottom: 10px;">ESTABLISHED 2026</p>
        <h1 class="brand-font" style="font-size:6rem; margin:0; line-height: 1;">The Archived <br>Mirage</h1>
        <button onclick="go('store')" style="background:var(--primary); color:var(--bg); padding:15px 40px; border:none; margin-top:30px; cursor:pointer; font-weight:600; letter-spacing: 2px; font-size: 0.7rem; border-radius: 5px;">SHOP COLLECTION</button>
    </section>

    <section id="store">
        <div class="search-container" style="margin-bottom: 20px;">
            <input type="text" id="storeSearch" placeholder="SEARCH PIECES..." oninput="renderStore()" style="text-align: center;">
        </div>
        <div class="filter-bar" id="categoryFilters">
            <button class="filter-btn active" onclick="filterBy('All')">All</button>
        </div>
        <div class="grid" id="products"></div>
    </section>

    <section id="contact">
        <div style="max-width:900px; margin:auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 80px;">
                <div>
                    <h2 class="brand-font" style="font-size:2.5rem; margin-top: 0;">Inquiries</h2>
                    <p style="opacity:0.6; font-size: 0.85rem; margin-bottom: 30px;">Our team is available for private consultations.</p>
                    <div style="font-size: 0.75rem; letter-spacing: 1px;">
                        <p style="margin-bottom: 15px;"><strong>WHATSAPP</strong><br><span id="displayWA" style="opacity:0.6">Loading...</span></p>
                        <p style="margin-bottom: 15px;"><strong>EMAIL</strong><br><span id="displayEmail" style="opacity:0.6">Loading...</span></p>
                        <p><strong>LOCATION</strong><br><span style="opacity:0.6">Dubai, UAE</span></p>
                    </div>
                </div>
                <div>
                    <div class="admin-box">
                        <input id="contactName" placeholder="NAME">
                        <input id="contactSubject" placeholder="SUBJECT">
                        <textarea id="contactMsg" placeholder="MESSAGE" rows="4"></textarea>
                        <button onclick="sendInquiry()" style="background:var(--primary); color:var(--bg); width:100%; padding:15px; border:none; font-weight:bold; cursor:pointer; letter-spacing: 2px; font-size: 0.7rem; border-radius: 5px;">SUBMIT</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="checkout">
        <div style="max-width:500px; margin:auto;">
            <h2 class="brand-font" style="font-size:2.5rem; text-align: center;">Finalize</h2>
            <div id="checkSummary" class="admin-box" style="font-size: 0.8rem; border-style: dashed; margin-bottom: 20px;"></div>
            <div class="admin-box">
                <input id="cN" placeholder="FULL NAME">
                <input id="cP" placeholder="PHONE NUMBER">
                <button onclick="placeOrder()" style="background:#000; color:white; font-size:0.8rem; padding:15px; width:100%; border:none; font-weight:bold; cursor:pointer; letter-spacing: 2px; border-radius: 5px;">PLACE ORDER</button>
            </div>
        </div>
    </section>

    <section id="admin">
        <div id="adminAuth" style="max-width:350px; margin:20px auto; text-align:center;">
            <h2 class="brand-font">Portal</h2>
            <div class="admin-box">
                <input type="password" id="pass" placeholder="PASSWORD" style="text-align: center;">
                <button onclick="checkAdmin()" style="background:var(--primary); color:var(--bg); width:100%; padding:15px; border:none; cursor:pointer; font-weight: bold; letter-spacing: 2px; border-radius: 5px;">ACCESS</button>
            </div>
        </div>
        <div id="adminPanel" style="display:none; max-width: 1000px; margin: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
                <h2 class="brand-font" style="font-size: 1.5rem;">Dashboard</h2>
                <button onclick="location.reload()" style="background:none; border: 1px solid var(--border); padding: 5px 15px; cursor:pointer; font-size: 10px; border-radius: 5px; color: var(--text);">EXIT</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div>
                    <div class="admin-box" style="background:var(--primary); color:var(--bg); text-align:center;">
                        <p style="font-size:0.5rem; margin:0; letter-spacing: 2px;">REVENUE</p>
                        <h2 id="revDisplay" style="margin:5px 0; font-family: 'Playfair Display';">0 AED</h2>
                    </div>
                    <h3 style="font-size: 0.8rem; letter-spacing: 2px; margin-top: 20px;">CATEGORIES</h3>
                    <div class="admin-box">
                        <input id="newCatName" placeholder="NAME">
                        <button onclick="window.addNewCategoryShortcut()" style="background:var(--primary); color:var(--bg); width:100%; padding:10px; border:none; cursor:pointer; font-size: 0.7rem; border-radius: 5px;">CREATE</button>
                    </div>
                </div>
                <div>
                    <input type="text" id="adminSearch" placeholder="SEARCH INVENTORY..." oninput="renderInventory()" style="margin-bottom:15px;">
                    <button onclick="window.addP()" style="background:var(--primary); color:var(--bg); padding:12px; width:100%; border:none; margin-bottom:20px; cursor:pointer; font-size: 0.7rem; border-radius: 5px;">+ NEW PIECE</button>
                    <div id="admProds"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <div class="admin-box">
                    <input id="setWA" placeholder="WHATSAPP">
                    <input id="setEmail" placeholder="EMAIL">
                    <button onclick="saveSettings()" style="background:var(--primary); color:var(--bg); width:100%; padding:12px; border:none; cursor:pointer; border-radius: 5px;">SAVE SETTINGS</button>
                </div>
                <div>
                  <h3 style="font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 15px;">ORDERS</h3>
                  <div id="admOrders"></div>
                </div>
            </div>
        </div>
    </section>
</main>

<footer>
    THE ARCHIVED MIRAGE <span class="copyright-symbol" onclick="go('admin')" style="cursor: pointer;">©</span> 2026 — ALL RIGHTS RESERVED
</footer>

<div id="cartOverlay" onclick="closeCart()"></div>
<div id="cartDrawer">
    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight:600; letter-spacing: 1px; font-size: 0.8rem;">SHOPPING BAG</span>
        <span onclick="closeCart()" style="cursor:pointer; font-size: 0.7rem; opacity: 0.5;">CLOSE</span>
    </div>
    <div class="cart-content" id="cartItemsList" style="flex: 1; overflow-y: auto; padding: 20px;"></div>
    <div style="padding: 20px; border-top: 1px solid var(--border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <span style="opacity:0.6; font-size: 0.8rem;">Total</span>
            <span id="cartTotalDisplay" style="font-weight:bold; font-size: 1rem;">0 AED</span>
        </div>
        <button class="checkout-btn" onclick="go('checkout')" style="background: var(--primary); color: var(--bg); width: 100%; padding: 15px; font-weight: 600; cursor: pointer; border: none; letter-spacing: 1px; border-radius: var(--radius);">CHECKOUT</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const conf = {
    apiKey: "AIzaSyDFLAL6I7ID_BY5weBVf6wx99jJXelhCH4",
    authDomain: "the-archived-mirage.firebaseapp.com",
    databaseURL: "https://the-archived-mirage-default-rtdb.firebaseio.com",
    projectId: "the-archived-mirage",
    storageBucket: "the-archived-mirage.firebasestorage.app",
    appId: "1:615352427360:web:dbebc6e1baac1b1742f405"
};

const app = initializeApp(conf);
const db = getDatabase(app);
let prods = [], cart = [], orders = [], settings = {}, curr = "home", activeFilter = "All";

window.go = (id) => {
    if(id === curr) return;
    document.getElementById(curr).classList.remove("active");
    document.getElementById(id).classList.add("active");
    curr = id;
    window.closeCart();
};

window.toggleTheme = () => document.body.classList.toggle('dark');
window.openCart = () => {
    document.getElementById('cartOverlay').style.display = "block";
    document.getElementById('cartDrawer').classList.add('open');
    renderCart();
};
window.closeCart = () => {
    document.getElementById('cartOverlay').style.display = "none";
    document.getElementById('cartDrawer').classList.remove('open');
};

window.sendInquiry = () => {
    const name = document.getElementById('contactName').value;
    const sub = document.getElementById('contactSubject').value;
    const msg = document.getElementById('contactMsg').value;
    if(!name || !msg) return alert("Please fill Name and Message");
    window.location.href = `mailto:${settings.email}?subject=${encodeURIComponent(sub || 'Inquiry')}&body=${encodeURIComponent("Name: "+name+"\n\n"+msg)}`;
};

window.addToCart = (fid) => {
    const p = prods.find(x => x.fid === fid);
    if(p.stock <= 0) return alert("Sorry, this item is out of stock!");
    const ex = cart.find(i => i.fid === fid);
    if(ex && ex.qty >= p.stock) return alert("You've added all available stock to your bag.");
    ex ? ex.qty++ : cart.push({...p, qty: 1});
    document.getElementById('cartCount').innerText = `(${cart.reduce((a,b)=>a+b.qty,0)})`;
    window.openCart();
};

function renderCart() {
    const list = document.getElementById('cartItemsList');
    if(cart.length === 0) { list.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>Your bag is empty</p>"; return; }
    let total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
    list.innerHTML = cart.map(i => `
        <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
            <div>
                <div style="font-weight:600; font-size: 0.8rem;">${i.name}</div>
                <div style="font-size: 0.7rem; opacity:0.6;">Qty: ${i.qty}</div>
            </div>
            <div style="font-weight:bold; font-size: 0.85rem;">${i.price * i.qty} AED</div>
        </div>`).join('');
    document.getElementById('cartTotalDisplay').innerText = total + " AED";
    document.getElementById('checkSummary').innerHTML = `<div style="display:flex; justify-content:space-between;"><span>Items:</span><span>${cart.length}</span></div><div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;"><span>Total:</span><span>${total} AED</span></div>`;
}

window.placeOrder = async () => {
    const n = document.getElementById('cN').value.trim();
    const p = document.getElementById('cP').value.trim();
    if(!n || !p) return alert("Fill your details.");
    if(cart.length === 0) return alert("Bag is empty.");
    const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
    const order = { customer: n, phone: p, items: cart.map(i => ({name: i.name, qty: i.qty, price: i.price})), total: total, status: 'Pending', date: new Date().toISOString() };
    try {
        await push(ref(db, 'orders'), order);
        for (const item of cart) {
            const productRef = ref(db, `products/${item.fid}`);
            const snapshot = await get(productRef);
            if(snapshot.exists()) {
                const currentStock = snapshot.val().stock || 0;
                await update(productRef, { stock: Math.max(0, currentStock - item.qty) });
            }
        }
        const msg = `*New Order*\n*Name:* ${n}\n*Items:* \n` + cart.map(i => `- ${i.name} (x${i.qty})`).join('\n') + `\n*Total:* ${total} AED`;
        const waUrl = `https://wa.me/${(settings.whatsapp || '971543108125').replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
        alert("Order Successful!");
        cart = []; document.getElementById('cartCount').innerText = "(0)"; window.location.href = waUrl;
    } catch (e) { alert(e.message); }
};

onValue(ref(db, 'settings'), (s) => {
    settings = s.val() || { whatsapp: "971543108125", email: "nuaimshariff@gmail.com" };
    document.getElementById('displayWA').innerText = "+" + settings.whatsapp;
    document.getElementById('displayEmail').innerText = settings.email;
});

window.filterBy = (cat) => { activeFilter = cat; renderStore(); };

window.renderStore = () => {
    const query = document.getElementById('storeSearch').value.toLowerCase();
    const cats = ["All", ...new Set(prods.map(p => p.category).filter(c => c))];
    document.getElementById('categoryFilters').innerHTML = cats.map(c => `<button class="filter-btn ${activeFilter === c ? 'active' : ''}" onclick="filterBy('${c}')">${c}</button>`).join('');
    let filtered = activeFilter === "All" ? prods : prods.filter(p => p.category === activeFilter);
    if(query) filtered = filtered.filter(p => p.name.toLowerCase().includes(query));
    document.getElementById("products").innerHTML = filtered.map(p => {
        const isOOS = p.stock <= 0;
        return `
        <div class="product">
            <div style="position:relative;">
                ${isOOS ? '<div style="position:absolute; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; color:white; font-size:0.6rem; letter-spacing:2px;">SOLD OUT</div>' : ''}
                <img src="${p.image}">
            </div>
            <div style="padding:12px;">
                <strong style="font-size: 0.75rem; display:block; text-transform:uppercase;">${p.name}</strong>
                <span style="font-size: 0.8rem; font-weight:600;">${p.price} AED</span>
                <button onclick="addToCart('${p.fid}')" ${isOOS ? 'disabled' : ''} style="background:${isOOS ? 'transparent' : 'var(--primary)'}; color:${isOOS ? 'var(--accent)' : 'var(--bg)'}; border:${isOOS ? '1px solid var(--border)' : 'none'}; width:100%; padding:8px; margin-top:10px; cursor:pointer; font-size: 0.6rem; font-weight:bold; border-radius:4px;">
                    ${isOOS ? 'OUT' : 'ADD'}
                </button>
            </div>
        </div>`
    }).join('');
}

onValue(ref(db, 'products'), (s) => {
    prods = s.val() ? Object.entries(s.val()).map(([id, v]) => ({...v, fid: id})) : [];
    window.renderStore(); window.renderInventory();
});

onValue(ref(db, 'orders'), (s) => {
    orders = s.val() ? Object.entries(s.val()).map(([id, v]) => ({...v, fid: id})) : [];
    const rev = orders.filter(o => o.status === 'Delivered').reduce((a,b)=>a+Number(b.total), 0);
    document.getElementById('revDisplay').innerText = rev + " AED";
    document.getElementById('admOrders').innerHTML = orders.slice().reverse().map(o => `
        <div class="admin-box" style="margin-bottom:10px; font-size:0.7rem; border-left: 3px solid ${o.status==='Pending'?'#8e8a82':'#4CAF50'};">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>${o.customer}</strong>
                <span style="font-weight:bold;">${o.total} AED</span>
            </div>
            <div id="details-${o.fid}" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); opacity:0.8;">
                <p><strong>Phone:</strong> ${o.phone}</p>
                <p><strong>Items:</strong><br>${o.items.map(i => `• ${i.name} (x${i.qty})`).join('<br>')}</p>
                <p style="font-size: 8px;">${new Date(o.date).toLocaleString()}</p>
            </div>
            <div style="margin-top:10px; display:flex; gap:5px;">
                <button onclick="document.getElementById('details-${o.fid}').style.display = document.getElementById('details-${o.fid}').style.display==='none'?'block':'none'" style="font-size:8px; background:var(--accent); color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;">DETAILS</button>
                <button onclick="window.upStatus('${o.fid}', 'Delivered')" style="font-size:8px; background:var(--primary); color:var(--bg); border:none; padding:4px 8px; border-radius:3px; cursor:pointer;">DONE</button>
                <button onclick="window.delO('${o.fid}')" style="font-size:8px; color:red; border:1px solid red; background:none; padding:4px 8px; border-radius:3px; cursor:pointer;">DEL</button>
            </div>
        </div>`).join('');
});

window.checkAdmin = () => { 
    if(document.getElementById('pass').value === "samariboys@buisness2026") { 
        document.getElementById('adminAuth').style.display="none"; 
        document.getElementById('adminPanel').style.display="block"; 
    } else { alert("Wrong"); }
};

window.saveSettings = () => set(ref(db, 'settings'), { whatsapp: document.getElementById('setWA').value, email: document.getElementById('setEmail').value }).then(() => alert("Saved"));

window.renderInventory = () => { 
    const query = document.getElementById('adminSearch')?.value.toLowerCase() || "";
    const filtered = prods.filter(p => p.name.toLowerCase().includes(query));
    document.getElementById('admProds').innerHTML = filtered.map(p => `
        <div class="admin-box" style="margin-bottom:10px;">
            <input value="${p.name}" onchange="window.upP('${p.fid}', 'name', this.value)">
            <div style="display:flex; gap:5px;">
                <input type="number" value="${p.price}" onchange="window.upP('${p.fid}', 'price', this.value)">
                <input type="number" value="${p.stock}" onchange="window.upP('${p.fid}', 'stock', this.value)">
            </div>
            <button onclick="window.delP('${p.fid}')" style="color:red; background:none; border:none; font-size:9px; cursor:pointer; text-transform:uppercase; letter-spacing:1px;">REMOVE PIECE</button>
        </div>`).join(''); 
}

window.addP = () => push(ref(db, 'products'), {name: "New Item", price: 0, stock: 1, category: "Archive", image: "https://via.placeholder.com/400"});
window.addNewCategoryShortcut = () => {
    const cat = document.getElementById('newCatName').value.trim();
    if(!cat) return alert("Name?");
    push(ref(db, 'products'), {name: "Template Item", price: 0, stock: 0, category: cat, image: "https://via.placeholder.com/400"});
    document.getElementById('newCatName').value = "";
};
window.upP = (id, k, v) => update(ref(db, `products/${id}`), {[k]: (k==='price' || k==='stock') ? Number(v) : v});
window.delP = (id) => confirm("Delete?") && remove(ref(db, `products/${id}`));
window.upStatus = (id, s) => update(ref(db, `orders/${id}`), {status: s});
window.delO = (id) => confirm("Clear?") && remove(ref(db, `orders/${id}`));
</script>
</body>
</html>
