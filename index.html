<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Archived Mirage</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@300;400;600&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

<style>
/* THEME VARIABLES */
:root {
    --bg: #e3ddd3; /* Darker Luxury Beige */
    --card: rgba(255, 255, 255, 0.6);
    --text: #1a1a1a;
    --border: rgba(0, 0, 0, 0.08);
    --primary: #000000;
    --accent: #8e8a82;
    --radius: 15px; 
    --shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
    --glass-blur: 20px;
}

body.dark {
    --bg: #0d0d0c;
    --card: rgba(26, 26, 24, 0.7);
    --text: #f0f0f0;
    --border: rgba(255, 255, 255, 0.1);
    --primary: #ffffff;
    --accent: #aaaaaa;
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; transition: background 0.4s ease, color 0.4s ease, border 0.4s ease; }

/* BETTER LIQUID ANIMATION */
body { 
    margin: 0; 
    font-family: 'Inter', sans-serif; 
    color: var(--text); 
    overflow-x: hidden; 
    line-height: 1.6;
    min-height: 100vh;
    background: var(--bg);
    background-image: 
        radial-gradient(at 0% 0%, rgba(215, 204, 185, 0.3) 0, transparent 50%), 
        radial-gradient(at 50% 0%, rgba(237, 232, 222, 0.3) 0, transparent 50%), 
        radial-gradient(at 100% 0%, rgba(215, 204, 185, 0.3) 0, transparent 50%);
    background-size: 200% 200%;
    animation: liquidMovement 10s infinite alternate ease-in-out;
}

@keyframes liquidMovement {
    0% { background-position: 0% 0%; }
    100% { background-position: 100% 100%; }
}

.brand-font { font-family: 'UnifrakturMaguntia', cursive; }

/* LUXURY INTRO UPGRADE */
#intro {
    position: fixed; inset: 0; background: #000; z-index: 10000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; animation: fadeOut 0.8s ease 3.8s forwards;
}

#intro h1 {
    font-size: 3.5rem; letter-spacing: 12px; margin: 0;
    animation: textAppear 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    opacity: 0; transform: translateY(20px);
}

#intro .line { 
    width: 0px; height: 1px; background: rgba(255,255,255,0.3); 
    margin: 25px 0; 
    animation: lineGrow 1.2s ease 1.2s forwards; 
}

#intro p {
    font-size: 0.65rem; letter-spacing: 6px; opacity: 0; text-transform: uppercase;
    animation: fadeIn 1s ease 2s forwards;
}

@keyframes textAppear { to { opacity: 1; transform: translateY(0); } }
@keyframes lineGrow { to { width: 300px; } }
@keyframes fadeIn { to { opacity: 0.6; } }
@keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

/* HEADER */
header { 
    background: var(--card); 
    border-bottom: 1px solid var(--border); 
    padding: 20px 40px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    position: sticky; 
    top: 0; 
    z-index: 500;
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
}

header > div, header > nav { flex: 1; }

.nav-right { 
    display: flex; 
    align-items: center; 
    gap: 30px; 
    justify-content: flex-end; 
}

nav { 
    display: flex; 
    gap: 30px; 
    align-items: center; 
    justify-content: center; 
}

nav a { 
    cursor: pointer; 
    font-weight: 400; 
    font-size: 0.7rem; 
    text-transform: uppercase; 
    letter-spacing: 2px; 
    text-decoration: none; 
    color: var(--text);
    opacity: 0.6;
}
nav a:hover { opacity: 1; }

/* THEME SWITCHER */
.theme-switch { position: relative; width: 40px; height: 20px; }
.theme-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; inset: 0; 
    background-color: var(--border);
    transition: .4s; border-radius: 20px;
}
.slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
    background-color: var(--text); transition: .4s; border-radius: 50%;
}
input:checked + .slider:before { transform: translateX(20px); }

/* SECTIONS */
main { 
    position: relative; 
    min-height: calc(100vh - 140px); 
    width: 100vw;
    display: flex;
    justify-content: center;
    align-items: center;
}

section {
    position: absolute; 
    width: 90%;
    max-width: 1200px;
    max-height: 85vh;
    padding: 60px 40px; 
    transition: 0.8s cubic-bezier(0.19, 1, 0.22, 1); 
    transform: translateY(30px); 
    opacity: 0;
    visibility: hidden; 
    overflow-y: auto; 
    z-index: 1;
    background: var(--card);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

section.active { 
    transform: translateY(0); 
    opacity: 1;
    visibility: visible; 
    z-index: 10; 
    pointer-events: all; 
}

/* STORE UI */
.filter-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
.filter-btn {
    background: transparent; border: 1px solid var(--border); color: var(--text);
    padding: 10px 20px; cursor: pointer; font-size: 0.65rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 2px; border-radius: 30px;
}
.filter-btn.active { background: var(--primary); color: var(--bg); border-color: var(--primary); }

.grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 40px; 
    max-width: 1400px; 
    margin: auto; 
    padding-bottom: 50px;
}

.product { 
    background: rgba(255,255,255,0.05); 
    transition: transform 0.4s ease;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
}
.product:hover { transform: translateY(-5px); }

.product img { width: 100%; aspect-ratio: 3/4; object-fit: cover; filter: grayscale(20%); transition: 0.5s; }
.product:hover img { filter: grayscale(0%); }

.out-of-stock-label {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); color: white; display: flex;
    align-items: center; justify-content: center; font-weight: 300;
    font-size: 0.8rem; letter-spacing: 4px; backdrop-filter: blur(2px);
}

/* FOOTER COPYRIGHT */
footer {
    padding: 40px;
    text-align: center;
    font-size: 0.6rem;
    letter-spacing: 3px;
    opacity: 0.5;
    text-transform: uppercase;
}

.copyright-symbol {
    cursor: pointer;
    transition: opacity 0.3s;
}
.copyright-symbol:hover { opacity: 1; color: var(--primary); }

/* CART DRAWER */
#cartDrawer {
    position: fixed; top: 0; right: -100%; width: 100%; max-width: 450px; height: 100%;
    background: var(--card); z-index: 2000; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    display: flex; flex-direction: column; box-shadow: -20px 0 60px rgba(0,0,0,0.1);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
}
#cartDrawer.open { right: 0; }
.cart-content { flex: 1; overflow-y: auto; padding: 40px; }
.checkout-btn { 
    background: var(--primary); color: var(--bg); width: 100%; padding: 20px; 
    font-weight: 600; cursor: pointer; border: none; letter-spacing: 2px;
    border-radius: var(--radius);
}

/* FORMS */
.admin-box { background: rgba(255,255,255,0.2); border: 1px solid var(--border); padding: 30px; margin-bottom: 20px; border-radius: var(--radius); }
input, textarea { 
    width: 100%; padding: 15px; margin-bottom: 15px; border: none; 
    border-bottom: 1px solid var(--border); background: transparent; color: inherit; 
    font-family: inherit; outline: none;
}
input:focus { border-bottom-color: var(--primary); }

#cartOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 1500; display: none; }

/* CUSTOM SCROLLBAR */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

/* Centering overrides for Home */
#home { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
</style>
</head>

<body class="dark">

<div id="intro">
    <h1 class="brand-font">The Archived Mirage</h1>
    <div class="line"></div>
    <p>Authenticity in every archive</p>
</div>

<header>
    <div class="brand-font" onclick="go('home')" style="cursor:pointer; font-size: 1.8rem; letter-spacing: 2px; white-space: nowrap;">The Archived Mirage</div>
    
    <nav>
        <a onclick="go('home')">Home</a>
        <a onclick="go('store')">Store</a>
        <a onclick="go('contact')">Contact</a>
        <a onclick="openCart()" style="position:relative; opacity: 0.6;">
            BAG <span id="cartCount" style="font-size: 10px; vertical-align: top; margin-left: 2px;">(0)</span>
        </a>
    </nav>
    
    <div class="nav-right">
        <label class="theme-switch">
            <input type="checkbox" id="themeToggle" onchange="toggleTheme()" checked>
            <span class="slider"></span>
        </label>
    </div>
</header>

<main>
    <section id="home" class="active">
        <p style="letter-spacing:8px; font-size: 0.7rem; opacity: 0.5; margin-bottom: 10px;">ESTABLISHED 2026</p>
        <h1 class="brand-font" style="font-size:6rem; margin:0; line-height: 1;">The Archived <br>Mirage</h1>
        <button onclick="go('store')" style="background:var(--primary); color:var(--bg); padding:20px 60px; border:none; margin-top:50px; cursor:pointer; font-weight:600; letter-spacing: 3px; font-size: 0.7rem; border-radius: 5px;">SHOP COLLECTION</button>
    </section>

    <section id="store">
        <div class="search-container">
            <input type="text" id="storeSearch" placeholder="SEARCH PIECES..." oninput="renderStore()" style="text-align: center; font-size: 0.8rem; letter-spacing: 2px;">
        </div>

        <div class="filter-bar" id="categoryFilters">
            <button class="filter-btn active" onclick="filterBy('All')">All</button>
        </div>

        <div class="grid" id="products"></div>
    </section>

    <section id="contact">
        <div style="max-width:900px; margin:auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 80px;">
                <div>
                    <h2 class="brand-font" style="font-size:3.5rem; margin-top: 0;">Inquiries</h2>
                    <p style="opacity:0.6; font-size: 0.9rem; margin-bottom: 40px;">Our team is available for private consultations regarding any archived pieces in our collection.</p>
                    <div style="font-size: 0.8rem; letter-spacing: 1px;">
                        <p style="margin-bottom: 20px;"><strong>WHATSAPP</strong><br><span id="displayWA" style="opacity:0.6">Loading...</span></p>
                        <p style="margin-bottom: 20px;"><strong>EMAIL</strong><br><span id="displayEmail" style="opacity:0.6">Loading...</span></p>
                        <p><strong>LOCATION</strong><br><span style="opacity:0.6">Dubai, United Arab Emirates</span></p>
                    </div>
                </div>
                <div>
                    <div class="admin-box">
                        <input id="contactName" placeholder="NAME">
                        <input id="contactSubject" placeholder="SUBJECT">
                        <textarea id="contactMsg" placeholder="MESSAGE" rows="6"></textarea>
                        <button onclick="sendInquiry()" style="background:var(--primary); color:var(--bg); width:100%; padding:20px; border:none; font-weight:bold; cursor:pointer; letter-spacing: 2px; font-size: 0.7rem; border-radius: 5px;">SUBMIT</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="checkout">
        <div style="max-width:500px; margin:auto;">
            <h2 class="brand-font" style="font-size:3rem; text-align: center;">Finalize</h2>
            <div id="checkSummary" class="admin-box" style="font-size: 0.9rem; border-style: dashed;"></div>
            <div class="admin-box">
                <input id="cN" placeholder="FULL NAME">
                <input id="cP" placeholder="PHONE NUMBER">
                <button onclick="placeOrder()" style="background:#000; color:white; font-size:0.8rem; padding:20px; width:100%; border:none; font-weight:bold; cursor:pointer; letter-spacing: 2px; border-radius: 5px;">PLACE ORDER</button>
            </div>
        </div>
    </section>

    <section id="admin">
        <div id="adminAuth" style="max-width:350px; margin:50px auto; text-align:center;">
            <h2 class="brand-font">Portal</h2>
            <input type="password" id="pass" placeholder="PASSWORD" style="text-align: center;">
            <button onclick="checkAdmin()" style="background:var(--primary); color:var(--bg); width:100%; padding:15px; border:none; margin-top:20px; cursor:pointer; font-weight: bold; letter-spacing: 2px; border-radius: 5px;">ACCESS</button>
        </div>
        <div id="adminPanel" style="display:none; max-width: 1000px; margin: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                <h2 class="brand-font" style="font-size: 2rem;">Dashboard</h2>
                <button onclick="location.reload()" style="background:none; border: 1px solid var(--border); padding: 8px 20px; cursor:pointer; font-size: 10px; letter-spacing: 1px; border-radius: 5px;">EXIT</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                <div>
                    <div class="admin-box" style="background:var(--primary); color:var(--bg); text-align:center;">
                        <p style="font-size:0.6rem; margin:0; letter-spacing: 2px;">REVENUE</p>
                        <h1 id="revDisplay" style="margin:10px 0; font-family: 'Playfair Display';">0 AED</h1>
                    </div>
                    <h3>Categories</h3>
                    <div class="admin-box">
                        <input id="newCatName" placeholder="CATEGORY NAME">
                        <button onclick="window.addNewCategoryShortcut()" style="background:var(--primary); color:var(--bg); width:100%; padding:12px; border:none; cursor:pointer; font-weight:bold; font-size: 0.7rem; border-radius: 5px;">CREATE</button>
                    </div>
                </div>
                <div>
                    <input type="text" id="adminSearch" placeholder="SEARCH INVENTORY..." oninput="renderInventory()" style="margin-bottom:20px;">
                    <button onclick="window.addP()" style="background:#1a1a1a; color:white; padding:15px; width:100%; border:none; margin-bottom:30px; cursor:pointer; font-weight: bold; font-size: 0.7rem; border-radius: 5px;">+ NEW PIECE</button>
                    <div id="admProds"></div>
                </div>
            </div>

            <h3 style="margin-top: 60px;">Orders & Settings</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="admin-box">
                    <input id="setWA" placeholder="WHATSAPP">
                    <input id="setEmail" placeholder="EMAIL">
                    <button onclick="saveSettings()" style="background:var(--primary); color:var(--bg); width:100%; padding:15px; border:none; cursor:pointer; font-weight:bold; border-radius: 5px;">SAVE</button>
                </div>
                <div id="admOrders"></div>
            </div>
        </div>
    </section>
</main>

<footer>
    THE ARCHIVED MIRAGE <span class="copyright-symbol" onclick="go('admin')">©</span> 2026 — ALL RIGHTS RESERVED
</footer>

<div id="cartOverlay" onclick="closeCart()"></div>
<div id="cartDrawer">
    <div style="padding: 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight:600; letter-spacing: 2px; font-size: 0.8rem;">SHOPPING BAG</span>
        <span onclick="closeCart()" style="cursor:pointer; font-size: 0.7rem; opacity: 0.5;">CLOSE</span>
    </div>
    <div class="cart-content" id="cartItemsList"></div>
    <div style="padding: 30px; border-top: 1px solid var(--border);">
        <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
            <span style="opacity:0.6; font-size: 0.9rem;">Total Amount</span>
            <span id="cartTotalDisplay" style="font-weight:bold; font-size: 1.1rem;">0 AED</span>
        </div>
        <button class="checkout-btn" onclick="go('checkout')">CHECKOUT</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const conf = {
    apiKey: "AIzaSyDFLAL6I7ID_BY5weBVf6wx99jJXelhCH4",
    authDomain: "the-archived-mirage.firebaseapp.com",
    databaseURL: "https://the-archived-mirage-default-rtdb.firebaseio.com",
    projectId: "the-archived-mirage",
    storageBucket: "the-archived-mirage.firebasestorage.app",
    appId: "1:615352427360:web:dbebc6e1baac1b1742f405"
};

const app = initializeApp(conf);
const db = getDatabase(app);
let prods = [], cart = [], orders = [], settings = {}, curr = "home", activeFilter = "All";

window.go = (id) => {
    if(id === curr) return;
    document.getElementById(curr).classList.remove("active");
    document.getElementById(id).classList.add("active");
    curr = id;
    window.closeCart();
};

window.toggleTheme = () => document.body.classList.toggle('dark');
window.openCart = () => {
    document.getElementById('cartOverlay').style.display = "block";
    document.getElementById('cartDrawer').classList.add('open');
    renderCart();
};
window.closeCart = () => {
    document.getElementById('cartOverlay').style.display = "none";
    document.getElementById('cartDrawer').classList.remove('open');
};

window.sendInquiry = () => {
    const name = document.getElementById('contactName').value;
    const sub = document.getElementById('contactSubject').value;
    const msg = document.getElementById('contactMsg').value;
    if(!name || !msg) return alert("Please fill Name and Message");
    window.location.href = `mailto:${settings.email}?subject=${encodeURIComponent(sub || 'Inquiry')}&body=${encodeURIComponent("Name: "+name+"\n\n"+msg)}`;
};

window.addToCart = (fid) => {
    const p = prods.find(x => x.fid === fid);
    if(p.stock <= 0) return alert("Sorry, this item is out of stock!");
    const ex = cart.find(i => i.fid === fid);
    if(ex && ex.qty >= p.stock) return alert("You've added all available stock to your bag.");
    ex ? ex.qty++ : cart.push({...p, qty: 1});
    document.getElementById('cartCount').innerText = `(${cart.reduce((a,b)=>a+b.qty,0)})`;
    window.openCart();
};

function renderCart() {
    const list = document.getElementById('cartItemsList');
    if(cart.length === 0) { list.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>Your bag is empty</p>"; return; }
    let total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
    list.innerHTML = cart.map(i => `
        <div style="margin-bottom:25px; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
            <div>
                <div style="font-weight:600; font-size: 0.9rem;">${i.name}</div>
                <div style="font-size: 0.7rem; opacity:0.6;">Quantity: ${i.qty}</div>
            </div>
            <div style="font-weight:bold;">${i.price * i.qty} AED</div>
        </div>`).join('');
    document.getElementById('cartTotalDisplay').innerText = total + " AED";
    document.getElementById('checkSummary').innerHTML = `<div style="display:flex; justify-content:space-between;"><span>Items:</span><span>${cart.length}</span></div><div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;"><span>Total:</span><span>${total} AED</span></div>`;
}

window.placeOrder = async () => {
    const n = document.getElementById('cN').value.trim();
    const p = document.getElementById('cP').value.trim();

    if(!n) return alert("Please enter your Full Name.");
    if(!p) return alert("Please enter your Phone Number.");
    if(cart.length === 0) return alert("Your shopping bag is empty.");

    const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
    const order = { 
        customer: n, 
        phone: p, 
        items: cart.map(i => ({name: i.name, qty: i.qty, price: i.price})), 
        total: total, 
        status: 'Pending', 
        date: new Date().toISOString() 
    };

    try {
        await push(ref(db, 'orders'), order);

        for (const item of cart) {
            const productRef = ref(db, `products/${item.fid}`);
            const snapshot = await get(productRef);
            if(snapshot.exists()) {
                const currentStock = snapshot.val().stock || 0;
                await update(productRef, { stock: Math.max(0, currentStock - item.qty) });
            }
        }
        
        const msg = `*New Order from The Archived Mirage*\n\n*Name:* ${n}\n*Phone:* ${p}\n\n*Items:* \n` + cart.map(i => `- ${i.name} (x${i.qty})`).join('\n') + `\n\n*Total:* ${total} AED`;
        const cleanNumber = (settings.whatsapp || '971543108125').replace(/\D/g, '');
        const waUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(msg)}`;

        alert("Order Successful! Opening WhatsApp for confirmation...");
        cart = []; 
        document.getElementById('cartCount').innerText = "(0)"; 
        window.location.href = waUrl;
    } catch (e) {
        alert("Transaction error: " + e.message);
    }
};

onValue(ref(db, 'settings'), (s) => {
    settings = s.val() || { whatsapp: "971543108125", email: "nuaimshariff@gmail.com" };
    document.getElementById('displayWA').innerText = "+" + settings.whatsapp;
    document.getElementById('displayEmail').innerText = settings.email;
});

window.filterBy = (cat) => {
    activeFilter = cat;
    renderStore();
};

window.renderStore = () => {
    const query = document.getElementById('storeSearch').value.toLowerCase();
    const cats = ["All", ...new Set(prods.map(p => p.category).filter(c => c))];
    
    document.getElementById('categoryFilters').innerHTML = cats.map(c => `
        <button class="filter-btn ${activeFilter === c ? 'active' : ''}" onclick="filterBy('${c}')">${c}</button>
    `).join('');

    let filtered = activeFilter === "All" ? prods : prods.filter(p => p.category === activeFilter);
    if(query) filtered = filtered.filter(p => p.name.toLowerCase().includes(query) || p.category?.toLowerCase().includes(query));

    document.getElementById("products").innerHTML = filtered.map(p => {
        const isOOS = p.stock <= 0;
        return `
        <div class="product">
            <div style="position:relative; overflow:hidden;">
                ${isOOS ? '<div class="out-of-stock-label">OUT OF STOCK</div>' : ''}
                <img src="${p.image}">
            </div>
            <div class="info" style="padding:20px; text-align:left;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong style="font-size: 0.9rem; text-transform:uppercase; letter-spacing:1px;">${p.name}</strong>
                        <div style="font-size: 0.7rem; opacity:0.5; margin-top:4px;">${p.category || 'Archive'}</div>
                    </div>
                    <div style="font-weight:600;">${p.price} AED</div>
                </div>
                <button onclick="addToCart('${p.fid}')" ${isOOS ? 'disabled' : ''} style="background:${isOOS ? 'transparent' : 'var(--primary)'}; color:${isOOS ? 'var(--accent)' : 'var(--bg)'}; border:${isOOS ? '1px solid var(--border)' : 'none'}; width:100%; padding:12px; margin-top:15px; cursor:${isOOS ? 'not-allowed' : 'pointer'}; font-size: 0.7rem; font-weight:bold; letter-spacing:1px; border-radius:5px;">
                    ${isOOS ? 'SOLD OUT' : 'ADD TO BAG'}
                </button>
            </div>
        </div>`
    }).join('');
}

onValue(ref(db, 'products'), (s) => {
    prods = s.val() ? Object.entries(s.val()).map(([id, v]) => ({...v, fid: id})) : [];
    window.renderStore();
    window.renderInventory();
});

onValue(ref(db, 'orders'), (s) => {
    orders = s.val() ? Object.entries(s.val()).map(([id, v]) => ({...v, fid: id})) : [];
    const rev = orders.filter(o => o.status === 'Delivered' && new Date(o.date).getMonth() === new Date().getMonth()).reduce((a,b)=>a+Number(b.total), 0);
    document.getElementById('revDisplay').innerText = rev + " AED";
    document.getElementById('admOrders').innerHTML = orders.slice().reverse().map(o => `
        <div class="admin-box" style="border-left: 4px solid ${o.status==='Pending'?'#ffcc00':'#00ff00'}; padding: 15px;">
            <div style="font-size:0.8rem; font-weight:bold;">${o.customer}</div>
            <div style="font-size:0.7rem; opacity:0.6;">${o.total} AED • ${o.status}</div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="window.upStatus('${o.fid}', 'Delivered')" style="background:#000; color:#fff; border:none; padding:5px 10px; cursor:pointer; font-size:9px;">MARK DELIVERED</button>
                <button onclick="window.delO('${o.fid}')" style="background:none; border: 1px solid #ff0000; color:#ff0000; padding:5px 10px; cursor:pointer; font-size:9px;">DELETE</button>
            </div>
        </div>`).join('');
});

window.checkAdmin = () => { 
    if(document.getElementById('pass').value === "samariboys@buisness2026") { 
        document.getElementById('adminAuth').style.display="none"; 
        document.getElementById('adminPanel').style.display="block"; 
    } else { alert("Incorrect Password"); }
};

window.saveSettings = () => set(ref(db, 'settings'), { whatsapp: document.getElementById('setWA').value, email: document.getElementById('setEmail').value }).then(() => alert("Saved"));

window.renderInventory = () => { 
    const query = document.getElementById('adminSearch')?.value.toLowerCase() || "";
    const filtered = prods.filter(p => p.name.toLowerCase().includes(query) || p.category?.toLowerCase().includes(query));

    document.getElementById('admProds').innerHTML = filtered.map(p => {
        const isLow = p.stock > 0 && p.stock <= 2;
        const isOut = p.stock <= 0;
        return `
        <div class="admin-box" style="border: 1px solid ${(isLow || isOut) ? 'red' : 'var(--border)'};">
            <div style="display:flex; justify-content:space-between;">
                 <span style="font-size:10px; font-weight:bold; color:red;">${isLow ? 'LOW STOCK' : (isOut ? 'OUT OF STOCK' : '')}</span>
                 <span onclick="window.delP('${p.fid}')" style="color:red; cursor:pointer; font-size:10px;">REMOVE</span>
            </div>
            <input placeholder="Item Name" value="${p.name}" onchange="window.upP('${p.fid}', 'name', this.value)">
            <input placeholder="Category" value="${p.category || ''}" onchange="window.upP('${p.fid}', 'category', this.value)">
            <div style="display:flex; gap:10px;">
                <input type="number" placeholder="Price" value="${p.price}" onchange="window.upP('${p.fid}', 'price', this.value)">
                <input type="number" placeholder="Stock" value="${p.stock || 0}" onchange="window.upP('${p.fid}', 'stock', this.value)">
            </div>
        </div>`;
    }).join(''); 
}

window.addP = () => push(ref(db, 'products'), {name: "New Item", price: 0, stock: 1, category: "Archive", image: "https://via.placeholder.com/400"});

window.addNewCategoryShortcut = () => {
    const cat = document.getElementById('newCatName').value.trim();
    if(!cat) return alert("Please enter a category name");
    push(ref(db, 'products'), {name: "Template Item", price: 0, stock: 0, category: cat, image: "https://via.placeholder.com/400"});
    document.getElementById('newCatName').value = "";
    alert("New category created with a template item.");
};

window.upP = (id, k, v) => update(ref(db, `products/${id}`), {[k]: (k==='price' || k==='stock') ? Number(v) : v});
window.delP = (id) => confirm("Delete?") && remove(ref(db, `products/${id}`));
window.upStatus = (id, s) => update(ref(db, `orders/${id}`), {status: s});
window.delO = (id) => confirm("Clear?") && remove(ref(db, `orders/${id}`));
</script>
</body>
</html>
