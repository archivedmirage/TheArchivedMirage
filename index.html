<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Archived Mirage | Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f6f7;--card:#ffffff;--text:#202223;--border:#e1e3e5;--primary:#000000;--glass:rgba(255,255,255,.55);}
body.dark{--bg:#0e0f11;--card:#16181c;--text:#eaeaea;--border:#2a2d33;--glass:rgba(20,20,25,.55);}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);overflow-x:hidden;transition:.3s;}
.brand-font {font-family: 'UnifrakturMaguntia', cursive; font-size: 1.5rem; letter-spacing: 1px;}
header{background:var(--card);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
nav a{margin-left:16px;cursor:pointer; font-weight: 500;}
.badge{background:red;color:#fff;border-radius:50%;padding:2px 7px;font-size:12px;}
section{display:none;padding:26px;max-width:1200px;margin:auto;}
section.active{display:block;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:22px;}
.product{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;padding:10px;}
.product img{width:100%;height:220px;object-fit:cover;border-radius:12px;}
button{background:var(--primary);color:#fff;border:none;padding:12px;border-radius:10px;font-weight:600;width:100%;cursor:pointer;margin-top:8px;}
input, textarea{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);}
#cartDrawer{position:fixed;top:0;right:-400px;width:350px;height:100%;background:var(--card);border-left:1px solid var(--border);padding:20px;transition:.3s;z-index:200;box-shadow:-5px 0 15px rgba(0,0,0,0.1);}
#cartDrawer.open{right:0;}
.order-card{background:var(--card);border:1px solid var(--border);padding:15px;border-radius:12px;margin-bottom:15px;}
.status-pending{color:orange; font-weight:bold;}
.status-delivered{color:green; font-weight:bold;}
.admin-tabs{display:flex; gap:10px; margin-bottom:20px;}
.tab-btn{background:#eee; color:#000; padding:8px; width:auto;}
.tab-btn.active{background:#000; color:#fff;}
</style>
</head>
<body class="dark">

<header>
<strong class="brand-font" onclick="go('home')" style="cursor:pointer">The Archived Mirage</strong>
<nav>
<a onclick="go('store')">Store</a>
<a onclick="go('contact')">Contact</a>
<a onclick="adminLogin()">Admin</a>
<a onclick="toggleCart()">ðŸ›’ <span class="badge" id="cartCount">0</span></a>
</nav>
</header>

<section id="home" class="active">
    <div style="text-align:center; padding:100px 20px;">
        <h1 class="brand-font" style="font-size:3rem;">The Archived Mirage</h1>
        <p>Premium Authentic Collections</p>
        <button onclick="go('store')" style="max-width:200px;">Shop Now</button>
    </div>
</section>

<section id="store">
    <h2>Our Collection</h2>
    <div class="grid" id="productGrid"></div>
</section>

<section id="checkout">
    <h2>Checkout</h2>
    <div id="checkoutItems"></div>
    <hr>
    <h3>Delivery Details</h3>
    <input id="custName" placeholder="Full Name">
    <input id="custPhone" placeholder="WhatsApp Number">
    <textarea id="custAddr" placeholder="Complete Delivery Address"></textarea>
    <button onclick="confirmOrder()" style="background:green;">Confirm Order via WhatsApp</button>
</section>

<section id="admin">
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="setAdminTab('products')">Products</button>
        <button class="tab-btn" onclick="setAdminTab('orders')">Orders</button>
        <button class="tab-btn" onclick="logout()" style="background:red">Logout</button>
    </div>
    <div id="adminContent"></div>
</section>

<div id="cartDrawer">
    <h3>Your Cart <button onclick="toggleCart()" style="width:auto; float:right; margin:0; padding:5px;">X</button></h3>
    <div id="cartItems" style="margin-top:20px;"></div>
    <div id="cartTotal" style="margin-top:20px; font-weight:bold;"></div>
    <button onclick="go('checkout')" id="checkoutBtn" style="display:none;">Proceed to Checkout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFLAL6I7ID_BY5weBVf6wx99jJXelhCH4",
  authDomain: "the-archived-mirage.firebaseapp.com",
  databaseURL: "https://the-archived-mirage-default-rtdb.firebaseio.com",
  projectId: "the-archived-mirage",
  storageBucket: "the-archived-mirage.firebasestorage.app",
  messagingSenderId: "615352427360",
  appId: "1:615352427360:web:dbebc6e1baac1b1742f405"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const ordersRef = ref(db, 'orders');

let products = [];
let orders = [];
let cart = [];
let isAdmin = false;
let currentTab = 'products';

// 1. DATA SYNC
onValue(productsRef, (s) => {
    const d = s.val();
    products = d ? Object.entries(d).map(([id, val]) => ({...val, fid: id})) : [];
    renderStore();
    if(isAdmin) renderAdmin();
});

onValue(ordersRef, (s) => {
    const d = s.val();
    orders = d ? Object.entries(d).map(([id, val]) => ({...id: id, ...val})) : [];
    if(isAdmin) renderAdmin();
});

// 2. NAVIGATION
window.go = (id) => {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'checkout') renderCheckout();
    closeCart();
};

// 3. STORE LOGIC
function renderStore() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = products.map(p => `
        <div class="product">
            <img src="${p.image}">
            <div style="padding:10px;">
                <strong>${p.name}</strong><br>
                <span>${p.price} AED</span>
                <button onclick="addToCart('${p.fid}')">Add to Cart</button>
            </div>
        </div>
    `).join('');
}

window.toggleCart = () => document.getElementById('cartDrawer').classList.toggle('open');
window.closeCart = () => document.getElementById('cartDrawer').classList.remove('open');

window.addToCart = (fid) => {
    const p = products.find(x => x.fid === fid);
    const exists = cart.find(i => i.fid === fid);
    exists ? exists.qty++ : cart.push({...p, qty: 1});
    updateCart();
    toggleCart();
};

function updateCart() {
    const items = document.getElementById('cartItems');
    const total = document.getElementById('cartTotal');
    const count = document.getElementById('cartCount');
    count.innerText = cart.reduce((a,b) => a+b.qty, 0);
    
    if(cart.length === 0) {
        items.innerHTML = "Cart is empty";
        total.innerHTML = "";
        document.getElementById('checkoutBtn').style.display = "none";
        return;
    }
    
    items.innerHTML = cart.map(i => `<div>${i.name} x${i.qty} - ${i.price * i.qty} AED</div>`).join('');
    total.innerHTML = `Total: ${cart.reduce((a,b) => a+(b.price*b.qty), 0)} AED`;
    document.getElementById('checkoutBtn').style.display = "block";
}

// 4. CHECKOUT & ORDERS
function renderCheckout() {
    const div = document.getElementById('checkoutItems');
    div.innerHTML = cart.map(i => `<div>${i.name} x${i.qty}</div>`).join('');
}

window.confirmOrder = () => {
    const name = document.getElementById('custName').value;
    const phone = document.getElementById('custPhone').value;
    const addr = document.getElementById('custAddr').value;
    if(!name || !phone || !addr) return alert("Fill all details");

    const newOrder = {
        customer: { name, phone, addr },
        items: cart,
        total: cart.reduce((a,b) => a+(b.price*b.qty), 0),
        status: 'Pending',
        date: new Date().toLocaleString()
    };

    const orderKey = push(ordersRef).key;
    set(ref(db, `orders/${orderKey}`), newOrder).then(() => {
        let text = `*New Order Mirage*%0AName: ${name}%0AItems: ${cart.map(i=>i.name).join(', ')}%0ATotal: ${newOrder.total} AED`;
        window.open(`https://wa.me/971543108125?text=${text}`);
        cart = []; updateCart(); go('home');
        alert("Order Placed Successfully!");
    });
};

// 5. ADMIN LOGIC
window.adminLogin = () => {
    if(isAdmin) return go('admin');
    const pass = prompt("Enter Admin Password:");
    if(pass === "samariboys@buisness2026") {
        isAdmin = true;
        renderAdmin();
        go('admin');
    }
};

window.setAdminTab = (t) => { currentTab = t; renderAdmin(); };

function renderAdmin() {
    const content = document.getElementById('adminContent');
    if(currentTab === 'products') {
        content.innerHTML = `<h3>Manage Products</h3><button onclick="addProduct()" style="background:green">+ New Product</button>` + 
        products.map(p => `
            <div class="order-card">
                <input value="${p.name}" onchange="editProd('${p.fid}', 'name', this.value)">
                <input type="number" value="${p.price}" onchange="editProd('${p.fid}', 'price', this.value)">
                <input value="${p.image}" onchange="editProd('${p.fid}', 'image', this.value)">
                <button onclick="delProd('${p.fid}')" style="background:red">Delete</button>
            </div>
        `).join('');
    } else {
        content.innerHTML = `<h3>Orders</h3>` + orders.map(o => `
            <div class="order-card">
                <strong>Status: <span class="status-${o.status.toLowerCase()}">${o.status}</span></strong><br>
                Customer: ${o.customer.name} (${o.customer.phone})<br>
                Items: ${o.items.map(i => i.name).join(', ')}<br>
                <strong>Total: ${o.total} AED</strong><br>
                <button onclick="updateStatus('${o.id}', 'Delivered')" style="background:blue; width:auto;">Mark Delivered</button>
                <button onclick="delOrder('${o.id}')" style="background:red; width:auto;">Delete Record</button>
            </div>
        `).join('');
    }
}

window.addProduct = () => push(productsRef, {name: "New Item", price: 0, image: "https://via.placeholder.com/400"});
window.editProd = (fid, k, v) => update(ref(db, `products/${fid}`), {[k]: k==='price'? Number(v) : v});
window.delProd = (fid) => confirm("Delete?") && remove(ref(db, `products/${fid}`));
window.updateStatus = (id, s) => update(ref(db, `orders/${id}`), {status: s});
window.delOrder = (id) => confirm("Delete order history?") && remove(ref(db, `orders/${id}`));
window.logout = () => { isAdmin = false; go('home'); };

</script>
</body>
</html>
